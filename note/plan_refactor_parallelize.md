# 並列化アルゴリズムの大規模改修プラン
## 概要
現在のHarpの実装では、並列化にメモリアクセスの調査などの複雑な処理を含んでおり、コードベースが膨大になってしまっている。そこで、今回の大規模改修では、並列化やループの操作などの巨視的な最適化を、Graph側のヒューリスティックな最適化として実装してしまうことにより、大幅なコードの簡略化と、よりGPUにとって扱いやすいものへの仕様変更を行うことを提案する。

## 最適化の流れについて
現在のパイプラインは、計算グラフのノード融合(決定論的) -> Lowering -> AST最適化（決定論的） -> AST最適化（ビームサーチ） -> コンパイル
のような流れになっており、ASTの最適化の段階で、ループ処理を展開、分割、あるいは最適化するなどの処理を行っている。

それを今回の改修ではグラフの段階で行うことにより、AST上でのメモリ解析を完全に廃止し、ループ処理などの最適化もグラフ上で行う。

## グラフのヒューリスティック最適化
ASTをビームサーチで最適化するように、グラフのコストを評価するモジュール(CostEstimator), グラフの編集を提案するモジュール(Suggester)を使って、ビームサーチなどを行う。
この際、コストの推定に関してだが、部分的にloweringできるなら、そのままASTのコスト推定を流用できるはずだ。

## グラフ操作でのループの置き換え
これは単純に、loweringするループの順番を入れ替えるか、処理の前後にpermuteノードを挿入し、結果的に同じ値を返すようにしていれば問題ない。

## グラフ操作でのループタイリング
これは展開の係数で割りきれるshapeであれば非常に簡単。対象の軸をより細分化した軸をView操作で新たに作ってしまえばよい。(reshapeのようなビュー操作を行う)
割り切れない場合はView側にパディングの機能を追加する必要があるだろう。
また、タイリング係数がコンパイル時に決定する（定数）のであれば、それをそのままSIMD化, ループ展開できるはず。
GPUでのShared Memory上への転送もこの段階で戦略を決定すれば良さそうだ。