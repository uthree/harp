# Harp - 全体仕様

## プロジェクト概要

Harpは多次元配列計算のためのJITコンパイル型テンソル計算ライブラリです。計算グラフから最適化されたCカーネルを自動生成し、CPUやGPU上で実行します。

[tinygrad](https://github.com/tinygrad/tinygrad)や[luminal](https://github.com/luminal-ai/luminal)にインスパイアされて開発されています。

## アーキテクチャ概要

```
┌─────────────────────────────────────────────┐
│           Tensor / Autograd API             │  ← ユーザー向けフロントエンド
├─────────────────────────────────────────────┤
│          Computation Graph (Graph)          │  ← テンソル演算の計算グラフ
├─────────────────────────────────────────────┤
│      Graph Optimization (opt/graph)         │  ← グラフレベルの最適化
├─────────────────────────────────────────────┤
│            Lowerer                          │  ← グラフをASTに変換
├─────────────────────────────────────────────┤
│         Abstract Syntax Tree (AST)          │  ← C言語的なAST表現
├─────────────────────────────────────────────┤
│       AST Optimization (opt/ast)            │  ← ASTレベルの最適化
├─────────────────────────────────────────────┤
│            Renderer                         │  ← ASTをターゲット言語に変換
├─────────────────────────────────────────────┤
│            Compiler                         │  ← コンパイルと実行
└─────────────────────────────────────────────┘
```

## モジュール構成

### コアモジュール

- **tensor** (`src/tensor/`)
  - ユーザー向けのテンソルAPI
  - 型安全な多次元配列操作
  - 自動微分機能（autograd）

- **graph** (`src/graph/`)
  - 計算グラフの表現
  - グラフノード（GraphNode）と演算子（GraphOp）
  - シェイプ情報とビュー管理

- **lowerer** (`src/lowerer/`)
  - 計算グラフをASTに変換
  - 各演算の具体的なループ構造を生成
  - トポロジカルソートによる実行順序の決定

- **ast** (`src/ast/`)
  - C言語的な抽象構文木
  - 数値演算、制御構造、メモリアクセスの表現
  - パターンマッチング機能

- **backend** (`src/backend/`)
  - バックエンドの抽象化
  - Renderer: ASTからソースコードを生成
  - Compiler: ソースコードをコンパイルして実行
  - Buffer: メモリ管理の抽象化

### 最適化モジュール

- **opt/graph** (`src/opt/graph/`)
  - グラフレベルの最適化
  - 演算融合（Fusion）
  - 計算の再構成

- **opt/ast** (`src/opt/ast/`)
  - ASTレベルの最適化
  - 定数畳み込み（Constant Folding）
  - 代数的簡約化（Algebraic Simplification）
  - ヒューリスティック最適化（ループ変換、タイリングなど）

## データフロー

1. **テンソル演算の定義**
   - ユーザーがTensor APIで演算を定義
   - 内部でGraphNodeとして計算グラフを構築

2. **グラフ最適化**
   - 複数の要素単位演算を融合（FusedElementwise）
   - 縮約演算の統合（FusedReduce）

3. **Lowering（グラフ→AST）**
   - 各グラフノードを具体的なループ構造に変換
   - メモリアクセスパターンを計算
   - トポロジカルソートで実行順序を決定

4. **AST最適化**
   - 定数畳み込み（`a + 0` → `a`など）
   - 代数的簡約化（`a * 1` → `a`など）
   - ループ最適化（アンロール、交換、タイリング）

5. **コード生成とコンパイル**
   - RendererがASTをC言語コードに変換
   - Compilerがコードをコンパイルして動的ライブラリを生成
   - 実行時にカーネルを呼び出し

## 主要な設計原則

### 1. レイヤー分離
各レイヤーは明確に分離され、それぞれ異なる抽象化レベルで動作します：
- Tensor: ユーザーフレンドリーなAPI
- Graph: 高レベルな演算の表現
- AST: 低レベルな実装詳細
- Backend: プラットフォーム固有の詳細

### 2. 段階的最適化
最適化は2段階で実行されます：
- グラフレベル: テンソル演算単位の最適化
- ASTレベル: ループとメモリアクセスの最適化

### 3. 型安全性
- DType: データ型の表現（F32, Isize, Usizeなど）
- Tensorの型パラメータによるコンパイル時チェック
- Dimension型による次元数のチェック

### 4. ビューとメモリレイアウト
- View: ストライドとオフセットによるメモリレイアウトの表現
- Contiguous操作: 非連続メモリを連続メモリに変換
- View操作: メモリコピーなしでテンソルの見え方を変更

## ライセンス

デュアルライセンス:
- Apache License 2.0
- MIT License
