# harp 仕様書

このディレクトリには、harpプロジェクトの技術仕様書が含まれています。

## プロジェクト概要

**harp (High-level Array Processor)** は、多次元配列の計算プロセスを表現した有向非循環グラフ（DAG）を元に、CPU、GPUなどのあらゆるデバイスにとって最適なパフォーマンスを発揮するカーネルを生成することを主な目的としたプロジェクトです。

### 主要機能

1. **計算グラフの表現と最適化**
   - 多次元配列演算をDAGで表現
   - デバイス非依存の中間表現

2. **デバイス固有の最適化**
   - CPU、GPU、その他アクセラレータに対応
   - 各デバイスに最適化されたコード生成

3. **副次的機能（計画中）**
   - PyTorchのような自動微分
   - ニューラルネットワーク機能
   - SciPyのような科学計算関数群

## 仕様書一覧

### [AST (抽象構文木)](./ast.md)

数値計算の式を木構造で表現するためのデータ構造の仕様。

**主要内容:**
- AstNode、AstOpの定義
- 型システム (DType)
- Ptr型によるメモリアクセス制御（GPU並列計算向け）
- パターンマッチングとリライタシステム
- 演算子オーバーロード

**重要な設計:**
- `DType::Ptr`の`mutable`フラグにより、読み取り専用/書き込み可能を型レベルで管理
- GPU並列処理における安全性とパフォーマンスを両立

## アーキテクチャ

```
ユーザーコード
    ↓
計算グラフ (DAG)
    ↓
AST (中間表現)
    ↓
最適化 (リライタ)
    ↓
バックエンド (CPU/GPU/...)
    ↓
実行可能コード
```

## 開発方針

### 型安全性

- Rustの型システムを活用し、コンパイル時に多くのエラーを検出
- GPU並列処理のメモリアクセスパターンを型で表現

### パフォーマンス

- ゼロコスト抽象化を重視
- デバイス固有の最適化を積極的に実施

### 拡張性

- モジュール化された設計
- 新しい演算子やバックエンドの追加が容易

## 今後の仕様書追加予定

- `spec/graph.md` - 計算グラフの仕様
- `spec/backend.md` - バックエンドインターフェースの仕様
- `spec/optimization.md` - 最適化パスの仕様
- `spec/gpu.md` - GPU固有の機能と最適化

## 仕様書の更新方針

1. **作業開始前**: 現在の仕様を確認
2. **仕様書が存在しない場合**: コードの全体的な構造を把握して仕様書を作成
3. **コード編集完了時**: 仕様書を更新
4. **コードと仕様書の相違**:
   - どちらを修正すべきか不明な場合は質問
   - 実装が正しい場合は仕様書を更新
   - 仕様が正しい場合はコードを修正

## バージョン履歴

- 2025-10-18: 初版作成
  - AST仕様書を追加
  - Ptr型のmutableフラグによるメモリアクセス制御を文書化
