# AST (抽象構文木)

## 概要

数値計算を表現するための抽象構文木を提供します。

## 設計思想と方針

### 演算の最小性原則

**既存の演算の組み合わせで表現可能な演算は、原則としてASTノードに実装しない**という設計方針です。演算子の種類を最小限に抑えることで、ASTの単純性・保守性・一貫性を確保します。

実装されている演算: `Add`, `Mul`, `Recip`, `Rem`, `Idiv`, `Max`, 数学関数（`Sqrt`, `Log2`, `Exp2`, `Sin`）

演算子オーバーロードで提供: 減算（`a - b = a + (-b)`）, 除算（`a / b = a * recip(b)`）

## Scopeと並列アクセス管理

変数の宣言と型管理、並列アクセスの安全性チェックを担当します。

### 並列アクセスの安全性

`AccessRegion`により変数のアクセスパターンを定義：
- **ThreadLocal**: スレッド固有（競合なし）
- **Shared**: 共有（同期が必要）
- **ShardedBy(axes)**: 軸でシャーディング（異なる軸なら並列アクセス可能）

`can_access_parallel()`による安全性チェック：
- 両方が`Immutable`（読み取り専用）
- 両方が`ThreadLocal`
- 異なる軸で`ShardedBy`

これにより、並列実行時のデータ競合を静的に検出できます。

## 主要コンポーネントの責務

### Block
複数の文をグループ化し、独立したスコープを提供。型推論では最後の文の型を返します（空なら`Tuple(vec![])`）。

### Range
範囲ベースのループを表現。ループ変数は自動的にスコープに宣言され、親スコープの変数にもアクセス可能です。

### Function
通常の関数とGPUカーネルを統一的に表現：
- `FunctionKind::Normal`: CPU上で逐次実行
- `FunctionKind::Kernel(ndim)`: GPU上で並列実行（ndimは並列次元数）

組み込み変数（`ThreadId`, `GroupId`等）はスコープに登録せず、特別扱いします。

### Program
複数の関数定義を管理し、`validate()`でエントリーポイントの存在と全関数本体の妥当性を検証します。

### Barrier
並列実行における同期点。GPU等で全スレッドがこの地点に到達するまで待機し、共有メモリアクセスのデータ競合を防ぎます。

## DType型変換

SIMD対応のベクトル型（`Vec<T, N>`）とメモリバッファ用のポインタ型（`Ptr<T>`）を提供。型変換メソッド（`to_vec`, `to_ptr`等）により、型を自由にネスト可能です（例: `Vec<Ptr<F32>>`, `Ptr<Vec<F32>>`）。
