# 今後の課題

このドキュメントでは、現在の実装における制限事項と今後の課題を記録します。

## 複数出力のサポート

**優先度**: 中
**ステータス**: 未実装

### 概要

現在の実装では`Graph::output()`は単一出力のみをサポートしています。複数回呼び出すとpanicします。

### 背景

複数出力をサポートしようとした際に、以下の問題が発見されました：

1. **参照カウントの問題**
   - 出力ノード`x`が別の出力`y`の入力として使用される場合（例: `y = x + 1.0`）
   - `x`の参照カウントが2になる（出力としての参照 + `y`への入力としての参照）
   - `KernelMergeSuggester`は参照カウントが1のノードのみをマージ対象とするため、マージが妨げられる

2. **複数のCustomノードの統合**
   - 複数の独立した出力がある場合、それぞれに対応するCustomノードが生成される
   - これらを単一のProgramに統合する処理が不完全
   - 特に、出力間で共有されるノードの取り扱いが複雑

### 現在の回避策

- `Graph::output()`は最初の呼び出しのみを許可
- 2回目以降の呼び出しはpanicする
- ユーザーは単一の出力を持つグラフを設計する必要がある

### 解決方針（案）

1. **参照カウント方式の見直し**
   - 出力ノードとして登録されたノードを特別扱いする
   - 出力ノード間の依存関係を考慮したマージ戦略

2. **複数出力用のLoweringパス**
   - 複数出力を持つグラフ専用のlowering処理
   - 共有ノードの重複排除と適切なバッファ管理

3. **Program構造の拡張**
   - 複数のカーネル出力を持つmain関数の生成
   - 出力バッファ間の依存関係を考慮したバリア挿入

### 関連コード

- `src/graph/mod.rs`: `Graph::output()` メソッド
- `src/opt/graph/suggesters/kernel_merge.rs`: `KernelMergeSuggester`
- `src/backend/generic.rs`: `extract_program_from_graph()`

### 参考

この問題は2024年11月に発見されました。暫定的に単一出力制限を導入し、将来的な解決を予定しています。
