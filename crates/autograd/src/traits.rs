use num_traits::One;

/// 逆伝播の中間点として使用可能な型
/// Clone を実装する全ての型に自動実装される
pub trait GradNode: Clone {}

/// 逆伝播の起点として使用可能な型
/// 初期勾配を生成するメソッドを持つ
pub trait GradRoot: GradNode {
    /// 初期勾配を生成（スカラーの場合は1.0）
    fn unit_grad() -> Self;
}

/// 勾配関数を表すトレイト (計算グラフのエッジ)
/// 逆伝播時に勾配を入力変数に伝播する
pub trait GradFn<GradType> {
    /// 出力側から受け取った勾配を入力側に伝播する
    fn backward(&mut self, grad_y: GradType);
}

// ============================================================================
// ブランケット実装
// ============================================================================

/// Clone を実装する全ての型は GradNode を自動実装
impl<T: Clone> GradNode for T {}

/// Clone + One を実装する全ての型は GradRoot を自動実装
impl<T: Clone + One> GradRoot for T {
    fn unit_grad() -> Self {
        T::one()
    }
}

// ============================================================================
// 縮約演算トレイト
// ============================================================================

/// 総和演算を表すトレイト
/// 指定した軸に沿って要素を合計する
pub trait Sum {
    /// 指定した軸で総和を計算
    fn sum(&self, axis: usize) -> Self;
}

/// 総乗演算を表すトレイト
/// 指定した軸に沿って要素を乗算する
pub trait Prod {
    /// 指定した軸で総乗を計算
    fn prod(&self, axis: usize) -> Self;
}

/// 最大値演算を表すトレイト
/// 指定した軸に沿って最大値を取得する
pub trait Max: Sized {
    /// 指定した軸で最大値を計算
    fn max(&self, axis: usize) -> Self;

    /// max の逆伝播を計算
    /// 最大値の位置にのみ勾配を伝播する
    /// - grad_output: 出力側の勾配
    /// - input: 順伝播時の入力値
    /// - output: 順伝播時の出力値（最大値）
    /// - axis: 縮約した軸
    /// - size: 縮約前の軸のサイズ
    fn max_grad(grad_output: &Self, input: &Self, output: &Self, axis: usize, size: usize) -> Self;
}

// ============================================================================
// 拡張演算トレイト
// ============================================================================

/// 軸方向の拡張演算を表すトレイト
/// 縮約演算の逆操作として使用
pub trait Expand {
    /// 指定した軸方向に拡張（ブロードキャスト）
    /// size: 拡張後のその軸のサイズ
    fn expand(&self, axis: usize, size: usize) -> Self;
}
